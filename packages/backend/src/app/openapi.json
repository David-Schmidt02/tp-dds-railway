{
  "openapi": "3.0.3",
  "info": {
    "title": "Tienda Sol - API",
    "version": "1.0.0",
    "description": "API de Tienda Sol — módulos: Pedidos, Productos, Notificaciones, Usuarios.\nStack: Express + Mongoose."
  },
  "servers": [
    {
      "url": "http://localhost:3000",
      "description": "Servidor local"
    }
  ],
  "tags": [
    { "name": "Pedidos", "description": "Operaciones relacionadas con pedidos" },
    { "name": "Productos", "description": "Operaciones relacionadas con productos" },
    { "name": "Notificaciones", "description": "Operaciones relacionadas con notificaciones" },
    { "name": "Usuarios", "description": "Operaciones relacionadas con usuarios" }
  ],
  "paths": {
    "/notificaciones": {
      "get": {
        "tags": ["Notificaciones"],
        "summary": "Obtener notificaciones de un usuario",
        "description": "Devuelve las notificaciones de un usuario, opcionalmente filtradas por estado leído/no leído.",
        "parameters": [
          {
            "name": "usuarioId",
            "in": "query",
            "required": true,
            "schema": { "type": "string" },
            "description": "ID del usuario receptor de las notificaciones"
          },
          {
            "name": "leida",
            "in": "query",
            "required": false,
            "schema": { "type": "boolean" },
            "description": "Filtra notificaciones por leídas (true) o no leídas (false)"
          }
        ],
        "responses": {
          "200": {
            "description": "Lista de notificaciones",
            "content": {
              "application/json": {
                "schema": { "type": "array", "items": { "$ref": "#/components/schemas/NotificacionDTO" } }
              }
            }
          },
          "400": {
            "description": "Falta el parámetro usuarioId",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorResponse" },
                "example": { "error": "BadRequest", "message": "Se requiere el ID del usuario" }
              }
            }
          },
          "500": {
            "description": "Error inesperado",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorResponse" },
                "example": { "error": "Error", "message": "Ups. Algo sucedió en el servidor." }
              }
            }
          }
        }
      },
      "patch": {
        "tags": ["Notificaciones"],
        "summary": "Marcar una notificación como leída",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "type": "object", "required": ["notificacionId"], "properties": { "notificacionId": { "type": "string" } } },
              "example": { "notificacionId": "66fabcd234567890abc12345" }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Notificación marcada como leída",
            "content": {
              "application/json": {
                "schema": { "type": "object", "properties": { "message": { "type": "string" } } },
                "example": { "message": "Notificación marcada como leída" }
              }
            }
          },
          "400": {
            "description": "Falta el ID de la notificación",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorResponse" },
                "example": { "error": "BadRequest", "message": "Se requiere el ID de la notificación" }
              }
            }
          },
          "500": {
            "description": "Error inesperado",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorResponse" },
                "example": { "error": "Error", "message": "Ups. Algo sucedió en el servidor." }
              }
            }
          }
        }
      }
    },
    "/pedidos": {
      "get": {
        "tags": ["Pedidos"],
        "summary": "Obtener todos los pedidos",
        "description": "Devuelve todos los pedidos (ordenados por fecha).",
        "responses": {
          "200": { "description": "Lista de pedidos", "content": { "application/json": { "schema": { "type": "array", "items": { "$ref": "#/components/schemas/PedidoDTO" } } } } },
          "500": { "description": "Error inesperado", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/ErrorResponse" } } } }
        }
      },
      "post": {
        "tags": ["Pedidos"],
        "summary": "Crear un nuevo pedido",
        "description": "Valida input, reserva stock, guarda el pedido y genera notificación al vendedor.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/PedidoInput" },
              "examples": {
                "valido": {
                  "value": {
                    "usuarioId": "66fabcd234567890abc12345",
                    "items": [
                      { "productoId": "66fabc1234567890abc12345", "cantidad": 2 },
                      { "productoId": "66fabc1234567890abc99999", "cantidad": 1 }
                    ],
                    "moneda": "PESO_ARG",
                    "direccionEntrega": {
                      "calle": "Av. Siempreviva",
                      "numero": "742",
                      "piso": "1",
                      "departamento": "2",
                      "codigoPostal": "1405",
                      "ciudad": "CABA",
                      "referencia": "Timbre verde"
                    },
                    "comentarios": "Por favor dejar en conserjería"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": { "description": "Pedido creado", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/PedidoDTO" } } } },
          "400": { "description": "Body inválido (Zod)", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/ValidationErrorResponse" } } } },
          "404": { "description": "ProductoInexistente | ProductoNoDisponible", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/ErrorResponse" } } } },
          "409": { "description": "ProductoStockInsuficiente", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/ErrorResponse" } } } },
          "500": { "description": "Error inesperado", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/ErrorResponse" } } } }
        }
      }
    },
    "/pedidos/historial": {
      "get": {
        "tags": ["Pedidos"],
        "summary": "Consultar historial de pedidos de un usuario",
        "parameters": [
          { "name": "usuarioId", "in": "query", "required": true, "schema": { "type": "string" }, "description": "ID del usuario" }
        ],
        "responses": {
          "200": { "description": "Historial de pedidos", "content": { "application/json": { "schema": { "type": "array", "items": { "$ref": "#/components/schemas/PedidoDTO" } } } } },
          "400": { "description": "Falta el parámetro usuarioId", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/ErrorResponse" } } } },
          "500": { "description": "Error inesperado", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/ErrorResponse" } } } }
        }
      }
    },
    "/pedidos/{id}": {
      "patch": {
        "tags": ["Pedidos"],
        "summary": "Cancelar un pedido",
        "parameters": [
          { "name": "id", "in": "path", "required": true, "schema": { "type": "string" }, "description": "ID del pedido a cancelar" }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": { "schema": { "type": "object", "required": ["motivo"], "properties": { "motivo": { "type": "string" } } }, "example": { "motivo": "Cliente canceló el pedido" } }
          }
        },
        "responses": {
          "200": { "description": "Pedido cancelado", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/PedidoDTO" } } } },
          "400": { "description": "Error en la solicitud", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/ErrorResponse" } } } },
          "404": { "description": "Pedido no encontrado", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/ErrorResponse" } } } },
          "500": { "description": "Error inesperado", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/ErrorResponse" } } } }
        }
      }
    },
    "/pedidos/{idPedido}/itemsPedidos/{idItem}": {
      "patch": {
        "tags": ["Pedidos"],
        "summary": "Cambiar cantidad de un item en un pedido",
        "parameters": [
          { "name": "idPedido", "in": "path", "required": true, "schema": { "type": "string" }, "description": "ID del pedido" },
          { "name": "idItem", "in": "path", "required": true, "schema": { "type": "string" }, "description": "ID del item dentro del pedido" }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": { "schema": { "type": "object", "required": ["cantidad"], "properties": { "cantidad": { "type": "integer", "minimum": 1 } } }, "example": { "cantidad": 3 } }
          }
        },
        "responses": {
          "200": { "description": "Pedido actualizado", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/PedidoDTO" } } } },
          "400": { "description": "Cantidad inválida", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/ErrorResponse" } } } },
          "404": { "description": "Pedido o item no encontrado", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/ErrorResponse" } } } },
          "500": { "description": "Error inesperado", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/ErrorResponse" } } } }
        }
      }
    },
    "/productos": {
      "get": {
        "tags": ["Productos"],
        "summary": "Obtener todos los productos",
        "description": "Devuelve la lista completa de productos disponibles. Permite paginación y filtros simples.",
        "parameters": [
          { "name": "page", "in": "query", "schema": { "type": "integer", "default": 1 }, "description": "Página de resultados" },
          { "name": "limit", "in": "query", "schema": { "type": "integer", "default": 10 }, "description": "Items por página" },
          { "name": "vendedorId", "in": "query", "schema": { "type": "string" }, "description": "Filtra productos por ID de vendedor" },
          { "name": "search", "in": "query", "schema": { "type": "string" }, "description": "Texto para buscar coincidencias en título/descr." },
          { "name": "minPrice", "in": "query", "schema": { "type": "number" }, "description": "Precio mínimo" },
          { "name": "maxPrice", "in": "query", "schema": { "type": "number" }, "description": "Precio máximo" }
        ],
        "responses": {
          "200": { "description": "Lista de productos paginada", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/ProductosPaginadosResponse" } } } },
          "500": { "description": "Error inesperado", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/ErrorResponse" } } } }
        }
      }
    },
    "/productos/ordenados": {
      "get": {
        "tags": ["Productos"],
        "summary": "Obtener productos ordenados",
        "parameters": [
          { "name": "page", "in": "query", "schema": { "type": "integer", "default": 1 } },
          { "name": "limit", "in": "query", "schema": { "type": "integer", "default": 10 } },
          { "name": "orden", "in": "query", "schema": { "type": "string", "enum": ["precioAsc", "precioDesc", "masVendido"], "default": "precioAsc" }, "description": "Criterio de ordenamiento" }
        ],
        "responses": {
          "200": { "description": "Productos ordenados (paginados)", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/ProductosPaginadosResponse" } } } },
          "500": { "description": "Error inesperado", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/ErrorResponse" } } } }
        }
      }
    },
    "/productos/vendedor": {
      "get": {
        "tags": ["Productos"],
        "summary": "Listar productos de un vendedor con filtros y paginación",
        "description": "Filtra por vendedor y otros parámetros (precio, nombre, descripción, categorías).",
        "parameters": [
          { "name": "vendedorId", "in": "query", "required": true, "schema": { "type": "string" }, "description": "ID del vendedor (obligatorio)" },
          { "name": "min", "in": "query", "schema": { "type": "number" }, "description": "Precio mínimo" },
          { "name": "max", "in": "query", "schema": { "type": "number" }, "description": "Precio máximo" },
          { "name": "nombre", "in": "query", "schema": { "type": "string" }, "description": "Filtro por título (regex)" },
          { "name": "descripcion", "in": "query", "schema": { "type": "string" }, "description": "Filtro por descripción (regex)" },
          { "name": "categorias", "in": "query", "schema": { "type": "string" }, "description": "Categorías separadas por coma" },
          { "name": "page", "in": "query", "schema": { "type": "integer", "default": 1 } },
          { "name": "limit", "in": "query", "schema": { "type": "integer", "default": 10 } },
          { "name": "orden", "in": "query", "schema": { "type": "string", "enum": ["precioAsc", "precioDesc", "masVendido", "createdAtDesc"] }, "description": "Criterio de orden" }
        ],
        "responses": {
          "200": { "description": "Productos del vendedor con paginación", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/ProductosPaginadosResponse" } } } },
          "400": { "description": "Parámetros inválidos", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/ErrorResponse" } } } },
          "500": { "description": "Error inesperado", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/ErrorResponse" } } } }
        }
      }
    },
    "/usuarios": {
      "post": {
        "tags": ["Usuarios"],
        "summary": "Crear usuario",
        "requestBody": {
          "required": true,
          "content": { "application/json": { "schema": { "$ref": "#/components/schemas/UsuarioCreateInput" }, "example": { "nombre": "Juan Pérez", "email": "juan@example.com", "telefono": "1123456789", "tipoUsuario": "comprador" } } }
        },
        "responses": {
          "201": { "description": "Usuario creado", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/UsuarioDTO" } } } },
          "400": { "description": "Datos inválidos", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/ValidationErrorResponse" } } } },
          "409": { "description": "Usuario ya existe", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/ErrorResponse" } } } },
          "500": { "description": "Error inesperado", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/ErrorResponse" } } } }
        }
      },
      "get": {
        "tags": ["Usuarios"],
        "summary": "Obtener todos los usuarios",
        "responses": {
          "200": { "description": "Lista de usuarios", "content": { "application/json": { "schema": { "type": "array", "items": { "$ref": "#/components/schemas/UsuarioDTO" } } } } },
          "500": { "description": "Error inesperado", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/ErrorResponse" } } } }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "NotificacionDTO": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "receptorId": { "type": "string" },
          "titulo": { "type": "string" },
          "mensaje": { "type": "string" },
          "leida": { "type": "boolean" },
          "fechaCreacion": { "type": "string", "format": "date-time" },
          "fechaLeida": { "type": "string", "format": "date-time", "nullable": true }
        }
      },
      "ItemPedidoInput": {
        "type": "object",
        "required": ["productoId", "cantidad"],
        "properties": {
          "productoId": { "type": "string", "example": "66fabc1234567890abc12345" },
          "cantidad": { "type": "integer", "minimum": 1, "example": 2 }
        }
      },
      "DireccionEntregaInput": {
        "type": "object",
        "required": ["calle", "numero", "codigoPostal", "ciudad"],
        "properties": {
          "calle": { "type": "string", "example": "Av. Siempreviva" },
          "numero": { "type": "string", "example": "742" },
          "piso": { "type": "string", "example": "1" },
          "departamento": { "type": "string", "example": "A" },
          "codigoPostal": { "type": "string", "example": "1405" },
          "ciudad": { "type": "string", "example": "CABA" },
          "referencia": { "type": "string", "example": "Timbre verde" }
        }
      },
      "PedidoInput": {
        "type": "object",
        "required": ["usuarioId", "items", "moneda", "direccionEntrega"],
        "properties": {
          "usuarioId": { "type": "string" },
          "items": { "type": "array", "minItems": 1, "items": { "$ref": "#/components/schemas/ItemPedidoInput" } },
          "moneda": { "type": "string", "enum": ["PESO_ARG", "DOLAR_USA", "REAL"], "example": "PESO_ARG" },
          "direccionEntrega": { "$ref": "#/components/schemas/DireccionEntregaInput" },
          "comentarios": { "type": "string" }
        }
      },
      "ItemPedidoDTO": {
        "type": "object",
        "properties": {
          "producto": {
            "type": "object",
            "properties": {
              "id": { "type": "string" },
              "titulo": { "type": "string" },
              "descripcion": { "type": "string" },
              "precio": { "type": "number" },
              "categoria": { "type": "string" }
            }
          },
          "cantidad": { "type": "integer" },
          "precioUnitario": { "type": "number" },
          "subtotal": { "type": "number" }
        }
      },
      "PedidoDTO": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "numero": { "type": "string" },
          "comprador": { "type": "object", "properties": { "id": { "type": "string" }, "nombre": { "type": "string" }, "email": { "type": "string", "format": "email" } } },
          "items": { "type": "array", "items": { "$ref": "#/components/schemas/ItemPedidoDTO" } },
          "direccionEntrega": { "$ref": "#/components/schemas/DireccionEntregaInput" },
          "estado": { "type": "string", "example": "PENDIENTE" },
          "historialEstados": { "type": "array", "items": { "type": "object", "properties": { "estadoAnterior": { "type": "string" }, "estadoNuevo": { "type": "string" }, "fecha": { "type": "string", "format": "date-time" }, "motivo": { "type": "string" } } } },
          "total": { "type": "number" },
          "fechaPedido": { "type": "string", "format": "date-time" },
          "fechaCreacion": { "type": "string", "format": "date-time" }
        }
      },
      "ProductoDTO": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "vendedor": { "type": "object", "properties": { "id": { "type": "string" }, "nombre": { "type": "string" } } },
          "titulo": { "type": "string" },
          "descripcion": { "type": "string" },
          "categorias": { "type": "array", "items": { "type": "string" } },
          "precio": { "type": "number" },
          "moneda": { "type": "string" },
          "stock": { "type": "integer" },
          "fotos": { "type": "array", "items": { "type": "object", "properties": { "url": { "type": "string", "format": "uri" } } } },
          "activo": { "type": "boolean" },
          "vendidos": { "type": "integer" },
          "createdAt": { "type": "string", "format": "date-time" },
          "updatedAt": { "type": "string", "format": "date-time" }
        }
      },
      "ProductosPaginadosResponse": {
        "type": "object",
        "properties": {
          "page": { "type": "integer", "example": 1 },
          "limit": { "type": "integer", "example": 10 },
          "totalItems": { "type": "integer", "example": 25 },
          "totalPages": { "type": "integer", "example": 3 },
          "items": { "type": "array", "items": { "$ref": "#/components/schemas/ProductoDTO" } }
        }
      },
      "UsuarioCreateInput": {
        "type": "object",
        "required": ["nombre", "email", "tipoUsuario"],
        "properties": {
          "nombre": { "type": "string" },
          "email": { "type": "string", "format": "email" },
          "telefono": { "type": "string" },
          "tipoUsuario": { "type": "string", "example": "comprador" }
        }
      },
      "UsuarioDTO": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "nombre": { "type": "string" },
          "email": { "type": "string", "format": "email" },
          "telefono": { "type": "string" },
          "tipoUsuario": { "type": "string" },
          "fechaAlta": { "type": "string", "format": "date-time" }
        }
      },
      "ValidationIssue": {
        "type": "object",
        "properties": {
          "path": { "type": "array", "items": { "type": "string" } },
          "message": { "type": "string" }
        }
      },
      "ValidationErrorResponse": {
        "type": "object",
        "properties": {
          "message": { "type": "string", "example": "Datos de entrada inválidos" },
          "details": { "type": "array", "items": { "$ref": "#/components/schemas/ValidationIssue" } }
        }
      },
      "ErrorResponse": {
        "type": "object",
        "properties": {
          "error": { "type": "string", "example": "ProductoInexistente" },
          "message": { "type": "string", "example": "El recurso solicitado no existe" }
        }
      }
    }
  }
}

